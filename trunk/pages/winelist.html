<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Wine List</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <script type="text/javascript">
      //<![CDATA[
var WineListTransform;

(function () {

    function getDataCleanupText() {
      var t;
      t = '<?xml version="1.0" encoding="utf-8"?><xsl:stylesheet version="1.0"';
      t = t + ' xmlns:xsl="http://www.w3.org/1999/XSL/Transform" > <xsl:output';
      t = t + ' method="xml" encoding="utf-8" indent="yes" /> <xsl:template ma';
      t = t + 'tch="row"> <xsl:copy> <xsl:apply-templates select="@* | node()"';
      t = t + '/> <TypeGroup><xsl:apply-templates mode="type-group" select="."';
      t = t + ' /><\/TypeGroup> <TypeGroupSortOrder><xsl:apply-templates mode=';
      t = t + '"type-group-sort-order" select="." /><\/TypeGroupSortOrder> <Va';
      t = t + 'rietalGroup><xsl:apply-templates mode="varietal-group" select="';
      t = t + '." /><\/VarietalGroup> <TypeGroupVarietalSortOrder><xsl:apply-t';
      t = t + 'emplates mode="type-group-varietal-sort-order" select="." /><\/';
      t = t + 'TypeGroupVarietalSortOrder> <LocaleAbbreviated><xsl:apply-templ';
      t = t + 'ates mode="locale-abbreviated" select="." /><\/LocaleAbbreviate';
      t = t + 'd> <\/xsl:copy> <\/xsl:template> <xsl:template mode="type-group';
      t = t + '" match="row [ Type = \'White - Sparkling\' or Type = \'Rosé - ';
      t = t + 'Sparkling\' or Type = \'Red - Sparkling\' or Type = \'Rosé\' or';
      t = t + ' Type = \'White\' or Type = \'White - Off-dry\' ]" > <xsl:value';
      t = t + '-of select="\'Sparkling, Rosé, and White Wines\'"/> <\/xsl:temp';
      t = t + 'late> <xsl:template mode="type-group" match="row [ Type = \'Red';
      t = t + '\' ]" > <xsl:value-of select="\'Red Wines\'"/> <\/xsl:template>';
      t = t + ' <xsl:template mode="type-group" match="row [ Type = \'White - ';
      t = t + 'Sweet/Dessert\' or Type = \'Rosé - Sweet/Dessert\' or Type = \'';
      t = t + 'Red - Sweet/Dessert\' ]" > <xsl:value-of select="\'Dessert Wine';
      t = t + 's\'"/> <\/xsl:template> <xsl:template mode="type-group" match="';
      t = t + 'row [ Type = \'White - Fortified\' or Type = \'Red - Fortified';
      t = t + '\' or Type = \'Fruit/Vegetable Wine\' or Type = \'Sake\' or Typ';
      t = t + 'e = \'Spirits\' or Type = \'Liqueur\' or Type = \'Non-alcoholic';
      t = t + '\' ]" > <xsl:value-of select="\'Other\'"/> <\/xsl:template> <xs';
      t = t + 'l:template mode="type-group" match="row"> <xsl:value-of select=';
      t = t + '"Type"/> <\/xsl:template> <xsl:template mode="type-group-sort-o';
      t = t + 'rder" match="row"> <xsl:choose> <xsl:when test="Type = \'White ';
      t = t + '- Sparkling\'"><xsl:value-of select="1"/><\/xsl:when> <xsl:when';
      t = t + ' test="Type = \'Rosé - Sparkling\'"><xsl:value-of select="2"/><';
      t = t + '\/xsl:when> <xsl:when test="Type = \'Red - Sparkling\'"><xsl:va';
      t = t + 'lue-of select="3"/><\/xsl:when> <xsl:when test="Type = \'Rosé\'';
      t = t + '"><xsl:value-of select="4"/><\/xsl:when> <xsl:when test="Type =';
      t = t + ' \'White\'"><xsl:value-of select="5"/><\/xsl:when> <xsl:when te';
      t = t + 'st="Type = \'White - Off-dry\'"><xsl:value-of select="6"/><\/xs';
      t = t + 'l:when> <xsl:when test="Type = \'Red\'"><xsl:value-of select="7';
      t = t + '"/><\/xsl:when> <xsl:when test="Type = \'White - Sweet/Dessert';
      t = t + '\'"><xsl:value-of select="8"/><\/xsl:when> <xsl:when test="Type';
      t = t + ' = \'Rosé - Sweet/Dessert\'"><xsl:value-of select="9"/><\/xsl:w';
      t = t + 'hen> <xsl:when test="Type = \'Red - Sweet/Dessert\'"><xsl:value';
      t = t + '-of select="10"/><\/xsl:when> <xsl:when test="Type = \'White - ';
      t = t + 'Fortified\'"><xsl:value-of select="11"/><\/xsl:when> <xsl:when ';
      t = t + 'test="Type = \'Red - Fortified\'"><xsl:value-of select="12"/><';
      t = t + '\/xsl:when> <xsl:when test="Type = \'Fruit/Vegetable Wine\'"><x';
      t = t + 'sl:value-of select="13"/><\/xsl:when> <xsl:when test="Type = \'';
      t = t + 'Sake\'"><xsl:value-of select="14"/><\/xsl:when> <xsl:when test=';
      t = t + '"Type = \'Spirits\'"><xsl:value-of select="15"/><\/xsl:when> <x';
      t = t + 'sl:when test="Type = \'Liqueur\'"><xsl:value-of select="16"/><';
      t = t + '\/xsl:when> <xsl:when test="Type = \'Non-alcoholic\'"><xsl:valu';
      t = t + 'e-of select="17"/><\/xsl:when> <xsl:otherwise><xsl:value-of sel';
      t = t + 'ect="18"/><\/xsl:otherwise> <\/xsl:choose> <\/xsl:template> <xs';
      t = t + 'l:template mode="varietal-group" match="row [ Type = \'Rosé\' ]';
      t = t + '" > <xsl:apply-templates mode="varietal-group-suffix" select=".';
      t = t + '"> <xsl:with-param name="varietal-group-base" select="\'Rosé\'"';
      t = t + ' /> <\/xsl:apply-templates> <\/xsl:template> <xsl:template mode';
      t = t + '="varietal-group" match="row [ Type = \'White\' and ( MasterVar';
      t = t + 'ietal = \'White Rhone Blend\' or MasterVarietal = \'Pinot Gris-';
      t = t + 'Pinot Blanc Blend\' ) ]" > <xsl:apply-templates mode="varietal-';
      t = t + 'group-suffix" select="."> <xsl:with-param name="varietal-group-';
      t = t + 'base" select="\'White Blend\'" /> <\/xsl:apply-templates> <\/xs';
      t = t + 'l:template> <xsl:template mode="varietal-group" match="row [ Ty';
      t = t + 'pe = \'Red\' and ( MasterVarietal = \'Cabernet-Syrah Blend\' ) ';
      t = t + ']" > <xsl:apply-templates mode="varietal-group-suffix" select="';
      t = t + '."> <xsl:with-param name="varietal-group-base" select="\'Red Bl';
      t = t + 'end\'" /> <\/xsl:apply-templates> <\/xsl:template> <xsl:templat';
      t = t + 'e mode="varietal-group" match="row [ Type = \'Red\' and ( Maste';
      t = t + 'rVarietal = \'Red Bordeaux Blend\' ) ]" > <xsl:apply-templates ';
      t = t + 'mode="varietal-group-suffix" select="."> <xsl:with-param name="';
      t = t + 'varietal-group-base" select="\'Red Blend - Bordeaux\'" /> <\/xs';
      t = t + 'l:apply-templates> <\/xsl:template> <xsl:template mode="varieta';
      t = t + 'l-group" match="row [ Type = \'Red\' and ( MasterVarietal = \'S';
      t = t + 'uperTuscan Blend\' ) ]" > <xsl:apply-templates mode="varietal-g';
      t = t + 'roup-suffix" select="."> <xsl:with-param name="varietal-group-b';
      t = t + 'ase" select="\'Red Blend - SuperTuscan\'" /> <\/xsl:apply-templ';
      t = t + 'ates> <\/xsl:template> <xsl:template mode="varietal-group" matc';
      t = t + 'h="row"> <xsl:apply-templates mode="varietal-group-suffix" sele';
      t = t + 'ct="."> <xsl:with-param name="varietal-group-base" select="Mast';
      t = t + 'erVarietal" /> <\/xsl:apply-templates> <\/xsl:template> <xsl:te';
      t = t + 'mplate mode="varietal-group-suffix" match="row [ Type = \'White';
      t = t + ' - Sparkling\' or Type = \'Rosé - Sparkling\' or Type = \'Red -';
      t = t + ' Sparkling\' ]" > <xsl:param name="varietal-group-base" /> <xsl';
      t = t + ':value-of select="\'Sparkling\'" /> <\/xsl:template> <xsl:templ';
      t = t + 'ate mode="varietal-group-suffix" match="row"> <xsl:param name="';
      t = t + 'varietal-group-base" /> <xsl:value-of select="$varietal-group-b';
      t = t + 'ase" /> <\/xsl:template> <xsl:template mode="type-group-varieta';
      t = t + 'l-sort-order" match="row"> <xsl:choose> <xsl:when test="Type = ';
      t = t + '\'White - Sparkling\'"><xsl:value-of select="1"/><\/xsl:when> <';
      t = t + 'xsl:when test="Type = \'Rosé - Sparkling\'"><xsl:value-of selec';
      t = t + 't="1"/><\/xsl:when> <xsl:when test="Type = \'Red - Sparkling\'"';
      t = t + '><xsl:value-of select="1"/><\/xsl:when> <xsl:when test="Type = ';
      t = t + '\'Rosé\'"><xsl:value-of select="2"/><\/xsl:when> <xsl:when test';
      t = t + '="Type = \'White\'"><xsl:value-of select="3"/><\/xsl:when> <xsl';
      t = t + ':when test="Type = \'White - Off-dry\'"><xsl:value-of select="3';
      t = t + '"/><\/xsl:when> <xsl:when test="Type = \'Red\'"><xsl:value-of s';
      t = t + 'elect="4"/><\/xsl:when> <xsl:when test="Type = \'White - Sweet/';
      t = t + 'Dessert\'"><xsl:value-of select="5"/><\/xsl:when> <xsl:when tes';
      t = t + 't="Type = \'Rosé - Sweet/Dessert\'"><xsl:value-of select="5"/><';
      t = t + '\/xsl:when> <xsl:when test="Type = \'Red - Sweet/Dessert\'"><xs';
      t = t + 'l:value-of select="6"/><\/xsl:when> <xsl:when test="Type = \'Wh';
      t = t + 'ite - Fortified\'"><xsl:value-of select="7"/><\/xsl:when> <xsl:';
      t = t + 'when test="Type = \'Red - Fortified\'"><xsl:value-of select="8"';
      t = t + '/><\/xsl:when> <xsl:when test="Type = \'Fruit/Vegetable Wine\'"';
      t = t + '><xsl:value-of select="9"/><\/xsl:when> <xsl:when test="Type = ';
      t = t + '\'Sake\'"><xsl:value-of select="9"/><\/xsl:when> <xsl:when test';
      t = t + '="Type = \'Spirits\'"><xsl:value-of select="9"/><\/xsl:when> <x';
      t = t + 'sl:when test="Type = \'Liqueur\'"><xsl:value-of select="9"/><\/';
      t = t + 'xsl:when> <xsl:when test="Type = \'Non-alcoholic\'"><xsl:value-';
      t = t + 'of select="9"/><\/xsl:when> <xsl:otherwise><xsl:value-of select';
      t = t + '="10"/><\/xsl:otherwise> <\/xsl:choose> <\/xsl:template> <xsl:t';
      t = t + 'emplate mode="locale-abbreviated" match="row [ Country = \'USA';
      t = t + '\' and Region = \'California\' and SubRegion = \'Unknown\' ]" >';
      t = t + ' <xsl:value-of select="\'California\'" /> <\/xsl:template> <xsl';
      t = t + ':template mode="locale-abbreviated" match="row [ Country = \'US';
      t = t + 'A\' and Region = \'California\' and SubRegion != \'Unknown\' an';
      t = t + 'd not(boolean(Appellation/text())) ]" > <xsl:value-of select="S';
      t = t + 'ubRegion" /> <\/xsl:template> <xsl:template mode="locale-abbrev';
      t = t + 'iated" match="row [ Country = \'USA\' and Region = \'California';
      t = t + '\' and SubRegion != \'Unknown\' and boolean(Appellation/text())';
      t = t + ' ]" > <xsl:value-of select="concat(SubRegion,\', \',Appellation';
      t = t + ')" /> <\/xsl:template> <xsl:template mode="locale-abbreviated" ';
      t = t + 'match="row [ Country = \'USA\' and Region != \'California\' and';
      t = t + ' boolean(Region/text()) ]" > <xsl:value-of select="substring(Lo';
      t = t + 'cale,string-length(\'USA, \') + 1)" /> <\/xsl:template> <xsl:te';
      t = t + 'mplate mode="locale-abbreviated" match="row [ Country = \'Franc';
      t = t + 'e\' and Region != \'France\' ]" > <xsl:value-of select="substri';
      t = t + 'ng(Locale,string-length(\'France, \') + 1)" /> <\/xsl:template>';
      t = t + ' <xsl:template mode="locale-abbreviated" priority="1" match="ro';
      t = t + 'w [ Locale = \'USA, California, Central Coast, Santa Rita Hills';
      t = t + ' - Sta. Rita Hills\' ]" > <xsl:value-of select="\'Central Coast';
      t = t + ', Sta. Rita Hills\'" /> <\/xsl:template> <xsl:template mode="lo';
      t = t + 'cale-abbreviated" match="row"> <xsl:value-of select="Locale" />';
      t = t + ' <\/xsl:template> <xsl:template match="@* | node()"> <xsl:copy>';
      t = t + ' <xsl:apply-templates select="@* | node()"/> <\/xsl:copy> <\/xs';
      t = t + 'l:template><\/xsl:stylesheet>';
      return t;
    }

    function getDataPresentationText() {
      var t;
      t = '<?xml version="1.0" encoding="utf-8"?><xsl:stylesheet version="1.0"';
      t = t + ' xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:msxsl="';
      t = t + 'urn:schemas-microsoft-com:xslt" xmlns="http://www.w3.org/1999/x';
      t = t + 'html" exclude-result-prefixes="msxsl" > <xsl:output method="htm';
      t = t + 'l" indent="yes" encoding="utf-8" omit-xml-declaration="no" doct';
      t = t + 'ype-public="-//W3C//DTD XHTML 1.0 Strict//EN" doctype-system="h';
      t = t + 'ttp://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd" /> <xsl:varia';
      t = t + 'ble name="wines-in-stock" select="/cellartracker/list/row[Quant';
      t = t + 'ity > 0 and Location != \'Wine Fridge - Tasting group\']" /> <x';
      t = t + 'sl:key name="wines-by-type-group" match="/cellartracker/list/ro';
      t = t + 'w[Quantity > 0 and Location != \'Wine Fridge - Tasting group\']';
      t = t + '" use="TypeGroup" /> <xsl:key name="wines-by-varietal-group" ma';
      t = t + 'tch="/cellartracker/list/row[Quantity > 0 and Location != \'Win';
      t = t + 'e Fridge - Tasting group\']" use="VarietalGroup" /> <xsl:key na';
      t = t + 'me="wines-by-id" match="/cellartracker/list/row[Quantity > 0 an';
      t = t + 'd Location != \'Wine Fridge - Tasting group\']" use="iWine" /> ';
      t = t + '<xsl:template match="/cellartracker"> <html> <head> <title>Wine';
      t = t + ' List<\/title> <\/head> <body> <div class="wine-list"> <xsl:for';
      t = t + '-each select="$wines-in-stock[count(. | key(\'wines-by-type-gro';
      t = t + 'up\', TypeGroup)[1]) = 1]"> <xsl:sort select="TypeGroupSortOrde';
      t = t + 'r" data-type="number" /> <xsl:variable name="current-type-group';
      t = t + '" select="TypeGroup" /> <div class="type-group"> <div class="ty';
      t = t + 'pe-heading"> <xsl:value-of select="TypeGroup" /> <\/div> <xsl:f';
      t = t + 'or-each select="$wines-in-stock[TypeGroup = $current-type-group';
      t = t + ' and count(. | key(\'wines-by-varietal-group\', VarietalGroup)[';
      t = t + '1]) = 1]"> <xsl:sort select="TypeGroupVarietalSortOrder" data-t';
      t = t + 'ype="number" /> <xsl:sort select="VarietalGroup" /> <xsl:variab';
      t = t + 'le name="current-varietal-group" select="VarietalGroup" /> <div';
      t = t + ' class="varietal-heading"> <xsl:value-of select="VarietalGroup"';
      t = t + ' /> <\/div> <xsl:for-each select="$wines-in-stock[TypeGroup = $';
      t = t + 'current-type-group and VarietalGroup = $current-varietal-group ';
      t = t + 'and count(. | key(\'wines-by-id\', iWine)[1]) = 1]"> <xsl:sort ';
      t = t + 'select="SortProducer" /> <xsl:sort select="Wine" /> <xsl:apply-';
      t = t + 'templates select="." /> <\/xsl:for-each> <\/xsl:for-each> <\/di';
      t = t + 'v> <\/xsl:for-each> <div class="legend"> <div>&#x25CA; Could be';
      t = t + 'nefit from further cellaring<\/div> <div>&#x2302; House quality';
      t = t + ' wine<\/div> <\/div> <\/div> <\/body> <\/html> <\/xsl:template>';
      t = t + ' <xsl:template match="row"> <div class="wine"> <span class="win';
      t = t + 'e-name-and-locale"> <xsl:choose> <xsl:when test="Location = \'W';
      t = t + 'ine Fridge - Future\'"> <span class="wine-status-indicator wine';
      t = t + '-status-future"> <xsl:text>&#x25CA;<\/xsl:text> <\/span> <xsl:t';
      t = t + 'ext> <\/xsl:text> <\/xsl:when> <xsl:when test="Location = \'Win';
      t = t + 'e Fridge - House\'"> <span class="wine-status-indicator wine-st';
      t = t + 'atus-house"> <xsl:text>&#x2302;<\/xsl:text> <\/span> <xsl:text>';
      t = t + ' <\/xsl:text> <\/xsl:when> <\/xsl:choose> <xsl:if test="Vintage';
      t = t + ' != \'1001\'"> <span class="vintage"> <xsl:value-of select="Vin';
      t = t + 'tage"/> <\/span> <xsl:text> <\/xsl:text> <\/xsl:if> <span class';
      t = t + '="wine-name"> <xsl:value-of select="Wine" /> <\/span> <xsl:text';
      t = t + '> <\/xsl:text> <span class="locale"> <xsl:text>(<\/xsl:text> <x';
      t = t + 'sl:value-of select="LocaleAbbreviated" /> <xsl:text>)<\/xsl:tex';
      t = t + 't> <\/span> <\/span> <span class="bin-and-price-list"> <xsl:for';
      t = t + '-each select="key(\'wines-by-id\', iWine)"> <xsl:sort select="B';
      t = t + 'in" data-type="number" /> <span class="bin"> <xsl:value-of sele';
      t = t + 'ct="Bin" /> <\/span> <xsl:if test="not(position() = last()) or ';
      t = t + 'number(Price) > 0"> <xsl:text>, <\/xsl:text> <\/xsl:if> <\/xsl:';
      t = t + 'for-each> <xsl:if test="number(Price) > 0"> <span class="price"';
      t = t + '> <xsl:text>$<\/xsl:text> <xsl:value-of select="ceiling(number(';
      t = t + 'Price))" /> <\/span> <\/xsl:if> <\/span> <\/div> <\/xsl:templat';
      t = t + 'e> <\/xsl:stylesheet>';
      return t;
    }

    var queryString,
        dataCleanupProcessor,
        dataPresentationProcessor,
        rawDataURL,
        rawDataXML;

    function el(id) {
      return document.getElementById(id);
    }

    // Assumes el is an Element
    function wrapElementCore(tagName, el) {
      var parent,
        root;
      
      root = el.parentNode;
      parent = document.createElement(tagName);
      root.insertBefore(parent, el);
      parent.appendChild(el);
      
      return parent;
    }

    function wrapElement(tagName, el) {
      var i,
        previousEl,
        length,
        parent;
      
      if (el instanceof Array || el instanceof NodeList) {
        
        length = el.length;
        
        // Iterate in reverse order sine the NodeList may be live updating.
        if (length > 0) {
          previousEl = el[length - 1];
          parent = wrapElementCore(tagName, previousEl);
          for (i = length - 2; i >= 0; i--) {
            parent.insertBefore(el[i], previousEl);
            previousEl = el[i];
          }
        }
        
      } else {
        parent = wrapElementCore(tagName, el);
      }
      
      return parent;
    }

    function wrapElementsToAvoidBreak(el) {
      var dataEl,
        rowEl,
        tableEl,
        bodyEl;
      
      dataEl = wrapElement('td', el);
      rowEl = wrapElement('tr', dataEl);
      bodyEl = wrapElement('tbody', rowEl);
      tableEl = wrapElement('table', bodyEl);
      tableEl.className = "avoid-break";
      
      return tableEl;
    }

    function getSingleElementByClassName(el, name) {
      var list;
      
      list = el.getElementsByClassName(name);
      if (list.length === 1) {
        return list[0];
      }
    }

    function getNameMaxWidthFromContents(wineEl) {
      var binEl;
      
      binEl = getSingleElementByClassName(wineEl, 'bin-and-price-list');
      return (wineEl.offsetWidth - binEl.offsetWidth) + 'px';
      
    }

    function updateWineLayout(wineEl, nameMaxWidth) {
      var binEl,
        localeEl,
        nameEl,
        wineMinHeight;
        
      //nameEl = getSingleElementByClassName(wineEl, 'wine-name-and-locale');
      //nameEl.style.maxWidth = nameMaxWidth;
      
      binEl = getSingleElementByClassName(wineEl, 'bin-and-price-list');
      wineEl.style.minHeight = binEl.offsetHeight + 'px';
      
      localeEl = getSingleElementByClassName(wineEl, 'locale');
      //Mimic negative lookbehind. See http://blog.stevenlevithan.com/archives/mimic-lookbehind-javascript
      localeEl.innerHTML = localeEl.innerHTML.replace(/(,)? /g, function($0, $1){
        return $1 ? $0 :  '&nbsp;';
      });
      
      // Hack for "column-break-inside: avoid;" support in Mozilla
      wrapElementsToAvoidBreak(wineEl.childNodes);
      
    }

    function updateAllWineLayout() {
      var i,
        length,
        nameMaxWidth,
        wineNodes;
      
      wineNodes = el('wine-list-wrapper').getElementsByClassName('wine');
      length = wineNodes.length;
      
      if (length > 0) {
        nameMaxWidth = getNameMaxWidthFromContents(wineNodes[0]);
        
        for (i = 0; i < length; i++) {
          updateWineLayout(wineNodes[i], nameMaxWidth);
        }
        
      }
      
    }

    function updateAllHeadingLayout(headingClassName) {
      var i,
        length,
        nodes;
      
      nodes = el('wine-list-wrapper').getElementsByClassName(headingClassName);
      length = nodes.length;
      
      for (i = 0; i < length; i++) {
        // Hack for "column-break-inside: avoid;" support in Mozilla
        wrapElementsToAvoidBreak([nodes[i], nodes[i].nextSibling]);
      }
      
    }

    function updateLayout() {
      updateAllWineLayout();
      updateAllHeadingLayout('varietal-heading');
      updateAllHeadingLayout('type-heading');
    }

    function getXMLSynchronousXHR(url) {
      var req;

      req = new XMLHttpRequest();
      req.open('GET', url, false);
      //req.setRequestHeader('encoding', 'utf-8');
      //req.overrideMimeType("text/xml; charset=utf-8");
      req.send(null);
      if (!(req.status == 200 || req.status == 0)) {
        return null;
      } else {
        return req.responseXML;
      }
    }

    function getRawQueryString() {
      var result,
          queryString,
          re,
          m;

      result = {};
      queryString = location.search.substring(1);
      re = /([^&=]+)=([^&]*)/g;

      while (m = re.exec(queryString)) {
        result[decodeURIComponent(m[1]).toLowerCase()] = m[2];
      }

      return result;
    }

    function getIsTwoColumnLayoutFromQueryString() {
      return queryString["columns"] == 2;
    }

    function getCredentialsFromQueryString() {
      return {
        user: queryString["user"],
        password: queryString["password"]
      };
    }

    function getCredentialsFromForm() {
      return {
        user: el('user-input').value,
        password: el('password-input').value
      };
    }

    function init() {
      var dataCleanupXML,
        dataPresentationXML,
        hidePricesParam,
        parser;

      queryString = getRawQueryString();
      hidePricesParam = queryString['hideprices'];
      if (typeof hidePricesParam !== "undefined") {
        if (hidePricesParam.toLowerCase() === 'true' || hidePricesParam === '1') {
          el('wine-list-wrapper').className += ' ' + 'hide-prices';
        }
      }

      parser = new DOMParser();

      dataCleanupXML = parser.parseFromString(getDataCleanupText(), "text/xml");
      dataCleanupProcessor = new XSLTProcessor();
      dataCleanupProcessor.importStylesheet(dataCleanupXML);

      dataPresentationXML = parser.parseFromString(getDataPresentationText(), "text/xml");
      dataPresentationProcessor = new XSLTProcessor();
      dataPresentationProcessor.importStylesheet(dataPresentationXML);
    }

    function processRawData() {
      var cleanDataXML,
          presentationHTML;

      cleanDataXML = dataCleanupProcessor.transformToDocument(rawDataXML);
      presentationHTML = dataPresentationProcessor.transformToDocument(cleanDataXML);
      el('wine-list-wrapper').innerHTML = presentationHTML.body.innerHTML;

      if (getIsTwoColumnLayoutFromQueryString()) {
        el('wine-list-wrapper').firstChild.className += " two-column";
      }
      updateLayout();
    }

    function getResponseErrorMessage(response) {
      var root,
          body;

      root = rawDataXML.documentElement;

      //An HTML response from CellarTracker indicates an error, stored in the body element.
      if (root && root.localName == "html" && root.namespaceURI === null) {
        body = root.firstChild;
        if (body && body.localName == "body" && body.namespaceURI === null) {
          return body.textContent;
        }
      }

      return;
    }

    function isLoginErrorResponse(response) {
      var responseErrorMessage;

      responseErrorMessage = getResponseErrorMessage(rawDataXML);
      if (responseErrorMessage == "You are currently not logged into CellarTracker.") {
        return true;
      }

      return false;
    }

    function loadRawDataUsingXHR(credentials) {
      rawDataURL = "http://www.cellartracker.com/xlquery.asp?table=List&Location=1&User=" + credentials.user + "&Password=" + credentials.password + "&Format=xml";
      rawDataXML = getXMLSynchronousXHR(rawDataURL);

      if (isLoginErrorResponse(rawDataXML)) {
        alert("There was an error logging in. Please visit CellarTracker to confirm that your handle and password are correct.");
        return false;
      }

      return true;
    }

    function setBlockElementVisible(id, visible) {
      var element;

      element = el(id);

      if (visible) {
        element.style.display = "block";
      } else {
        element.style.display = "none";
      }
    }

    function setMainContentVisible(visible) {
      setBlockElementVisible('main', visible);
    }

    function setWineListVisible(visible) {
      setBlockElementVisible('wine-list-wrapper', visible);
    }

    function showMainContent() {
      setMainContentVisible(true);
      setWineListVisible(false);
    }

    function showWineList() {
      setMainContentVisible(false);
      setWineListVisible(true);
    }

    function updatePageState(credentials, succeeded) {
      var queryCredentials,
          newUri;

      queryCredentials = getCredentialsFromQueryString();

      if (succeeded) {
        showWineList();
        processRawData();

        if (queryCredentials.user !== credentials.user || queryCredentials.password !== credentials.password) {
          newUri = "?User=" + encodeURIComponent(credentials.user) + "&Password=" + encodeURIComponent(credentials.password);
        }

      } else {
        showMainContent();

        if (queryCredentials.user || queryCredentials.password) {
          newUri = "?";
        }
      }

      if (newUri) {
        window.onpopstate = function () {
          queryString = getRawQueryString();
          loadWineListWithQueryStringCredentials();
        };

        window.history.pushState(null, 'Wine List', newUri);
        queryString = getRawQueryString();
      }
    }

    function loadWineList(credentials) {
      var succeeded;

      if (credentials.user && credentials.password) {
        succeeded = loadRawDataUsingXHR(credentials);
      }

      updatePageState(credentials, succeeded);

      return succeeded;
    }

    function loadWineListWithQueryStringCredentials() {
      var credentials;

      credentials = getCredentialsFromQueryString();
      loadWineList(credentials);
    }

    function loadWineListWithFormCredentials() {
      var credentials;

      credentials = getCredentialsFromForm();

      if (credentials.user && credentials.password) {
        loadWineList(credentials);

      } else {
        alert("A CellarTracker handle and password are required.");
        updatePageState(credentials, false);
      }
    }

  WineListTransform = {

    loadWineList: function () {
      init();
      loadWineListWithQueryStringCredentials();
    },

    handleCredentialsFormSubmit: function (e) {
      e.preventDefault();
      loadWineListWithFormCredentials();
    }

  };

})();
    //]]>
    </script>

    <style type="text/css">
    #main {
      margin-left: auto;
      margin-right: auto;
      width: 40%;
      min-width: 35em;
      display: none;
    }

    #credentials-prompt {
      text-align: center;
      margin: 0.5em;
    }

    #credentials-prompt > span {
      display: inline-block;
      border: 1px solid black;
      text-align: left;
    }

    #credentials-fields {
      padding: 0.2em 0.5em 0.2em 0.5em;
    }

    #footer {
      text-align: center;
    }
    </style>

    <style type="text/css">
    body {
      font-size: 100%;
      min-width: 550px;
    }

    .wine-list {
      -webkit-column-count: 3;
      -webkit-column-gap: 20px;
      /*
      -webkit-column-width: 20em;
      -webkit-column-gap: 2em;
      */
      -webkit-column-rule-color: black;
      -webkit-column-rule-style: solid;
      -webkit-column-rule-width: 2px;
      -moz-column-count: 3;
      -moz-column-gap: 20px;
      /*
      -moz-column-width: 20em;
      -moz-column-gap: 2em;
      */
      -moz-column-rule-color: black;
      -moz-column-rule-style: solid;
      -moz-column-rule-width: 2px;
      column-count: 3;
      column-gap: 20px;
      /*
      -column-width: 20em;
      -column-gap: 2em;
      */
      column-rule-color: black;
      column-rule-style: solid;
      column-rule-width: 2px;
    }

    .type-group {
    }

    .wine-list.two-column {
      -webkit-column-count: 2;
      -moz-column-count: 2;
      column-count: 2;
    }

    .type-heading {
      font-size: 2em;
      font-weight: bold;
      font-family: Arial,Helvetica,sans-serif;
      font-variant: small-caps;
      text-align: center;
      background: #F3F3F3;
      border-top: solid windowtext .5pt;
      border-bottom: solid windowtext .5pt;
      margin-bottom: 0.3em;
    }

    .varietal-group {
    }

    .varietal-heading {
      margin-top: 0.6em;
      font-weight: bold;
    }

    .wine {
      margin-bottom: 0.2em;
      position: relative; /* Establish a fixed position so children can absolutely position themselves. */
      -webkit-column-break-inside: avoid;
      -moz-column-break-inside: avoid;
      column-break-inside: avoid;
    }

    table.avoid-break {
      width: 100%;
      -webkit-column-break-inside: avoid;
      -moz-column-break-inside: avoid;
      column-break-inside: avoid;
    }

    table.avoid-break td {
      padding: 0;
    }

    .wine-name-and-locale {
      display: block; /* Display must be block or inline-block so the width rules are respected. */
      /*width: 14.5em;*/ /* (Column width) minus (bin and price list width and padding) */
      width: 78%;
    }

    .wine-name {
    }

    .locale {
      font-style: italic;
      font-size: 0.8em;
      /* white-space: nowrap; */
    }

    .bin-and-price-list {
      text-align: right;
      padding-left: 2%;
      display: block; /* Display must be block or inline-block so the width rules are respected. */
      width: 20%; /* Use the same width so we don't have to recompute the width available for the wine name on each row. */
      position: absolute;
      right: 0;
      top: 0;
    }

    .hide-prices .price-list-item {
      display: none;
    }

    .price {
      font-style: italic;
    }

    .legend {
      padding-top: 0.5em;
      /* -webkit-column-break-inside: avoid; */
      /* break-inside: avoid-column; */
    }
  </style>
  </head>
  <body onload="WineListTransform.loadWineList();">
    <div id="main">
      <h1>Cellar View</h1>
      <p>Extend the viewing options available from CellarTracker. Provide your CellarTracker!&trade; information below, then load the wine list. Bookmark the wine list page to get back to it without reentering your user information.</p>
      <p>Note that your password will be sent to CellarTracker in plain text and will be visible in your browser's address bar.</p>
      <div id="credentials-prompt">
        <span>
          <form id="credentials-form" onSubmit="WineListTransform.handleCredentialsFormSubmit(event);">
            <table id="credentials-fields">
              <tr>
                <th colspan="2">CellarTracker!&trade; user information</th>
              </tr>
              <tr>
                <td>Handle:</td>
                <td><input id="user-input" type="text" /></td>
              </tr>
              <tr>
                <td>Password:</td>
                <td><input id="password-input" type="password" /></td>
              </tr>
              <tr>
                <td colspan="2" align="right">
                  <input type="submit" value="Load wine list" />
                </td>
              </tr>
            </table>
          </form>
        </span>
      </div>
      <div id="footer">
        <span><a href="http://code.google.com/p/cellar-view/" title="Cellar View on Google Code">About Cellar View</a> - <a href="http://www.cellartracker.com/">CellarTracker!&trade;</a>
      </div>
    </div>
    <div id="wine-list-wrapper"></div>
  </body>
</html>
